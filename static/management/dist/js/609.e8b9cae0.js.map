{"version":3,"file":"js/609.e8b9cae0.js","mappings":"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","sources":["webpack://zmwk_session_archive/./src/api/session.js","webpack://zmwk_session_archive/./src/views/sessionArchive/search.vue","webpack://zmwk_session_archive/./src/views/sessionArchive/search.vue?0b35"],"sourcesContent":["import request from \"@/api/request\";\r\n\r\nexport const staffCstSessions = data => {\r\n    return request.get(\"/api/chats/by/staff/customer/conversation/list\", {params: data})\r\n}\r\n\r\nexport const staffSessions = data => {\r\n    return request.get('/api/chats/by/staff/staff/conversation/list', {params: data})\r\n}\r\n\r\nexport const groupSessions = data => {\r\n    return request.get('/api/chats/by/staff/room/conversation/list', {params: data})\r\n}\r\n\r\nexport const cstSessions = data => {\r\n    return request.get('/api/chats/by/customer/staff/conversation/list', {params: data})\r\n}\r\n\r\nexport const sessionMessage = data => {\r\n    return request.get('/api/chats/by/conversation/message/list', {params: data})\r\n}\r\n\r\nexport const groupMessage = data => {\r\n    return request.get('/api/chats/by/group/message/list', {params: data})\r\n}\r\n\r\nexport const searchSession = data => {\r\n    return request.get('/api/chats/search', {params: data})\r\n}\r\n","<template>\r\n    <MainLayout title=\"会话搜索\">\r\n        <div class=\"zm-main-content\">\r\n            <a-alert show-icon message=\"功能说明：支持通过关键词、单聊/群聊、会话时间等搜索条件查询会话内容\"></a-alert>\r\n            <div class=\"mt16\">\r\n                <a-input-search\r\n                    v-model:value=\"filterData.keyword\"\r\n                    style=\"width: 600px;\"\r\n                    size=\"large\"\r\n                    placeholder=\"请输入会话内容关键词搜索\"\r\n                    allowClear\r\n                    @search=\"search\">\r\n                    <template #enterButton>\r\n                        <a-button :icon=\"h(SearchOutlined)\" type=\"primary\">搜 索</a-button>\r\n                    </template>\r\n                </a-input-search>\r\n            </div>\r\n            <div class=\"zm-filter-box\">\r\n                <div class=\"zm-filter-item\">\r\n                    <span class=\"zm-filter-label\">会话类型：</span>\r\n                    <div>\r\n                        <a-select v-model:value=\"filterData.session_type\"\r\n                                  style=\"width: 220px;\"\r\n                                  @change=\"search\"\r\n                                  placeholder=\"请选择会话类型\"\r\n                                  allowClear>\r\n                            <a-select-option :value=\"1\">单聊</a-select-option>\r\n                            <a-select-option :value=\"2\">群聊</a-select-option>\r\n                        </a-select>\r\n                    </div>\r\n                </div>\r\n                <div class=\"zm-filter-item\">\r\n                    <span class=\"zm-filter-label\">发送时间：</span>\r\n                    <div>\r\n                        <a-range-picker\r\n                            v-model:value=\"filterData.dates\"\r\n                            style=\"width: 220px;\"\r\n                            @change=\"filterDateChange\"\r\n                            :disabled-date=\"disabledDate\"/>\r\n                    </div>\r\n                </div>\r\n                <div class=\"zm-filter-item\">\r\n                    <span class=\"zm-filter-label\">发送人：</span>\r\n                    <div>\r\n                        <a-input-group compact>\r\n                            <a-select\r\n                                v-model:value=\"filterData.from_type\"\r\n                                style=\"width: 80px;\"\r\n                                @change=\"search\"\r\n                                placeholder=\"请选择会话类型\"\r\n                            >\r\n                                <a-select-option :value=\"0\">全部</a-select-option>\r\n                                <a-select-option :value=\"1\">客户</a-select-option>\r\n                                <a-select-option :value=\"2\">员工</a-select-option>\r\n                            </a-select>\r\n                            <a-input v-model:value=\"filterData.from\"\r\n                                     style=\"width: 220px;\"\r\n                                     placeholder=\"选择输入发送人名称\"/>\r\n                        </a-input-group>\r\n                    </div>\r\n                </div>\r\n                <!--                <div class=\"zm-filter-item\">-->\r\n                <!--                    <span class=\"zm-filter-label\">发送群聊：</span>-->\r\n                <!--                    <div>-->\r\n                <!--                        <a-input v-model:value=\"filterData.group\"-->\r\n                <!--                                 style=\"width: 220px;\"-->\r\n                <!--                                 placeholder=\"选择输入群聊名称\"/>-->\r\n                <!--                    </div>-->\r\n                <!--                </div>-->\r\n            </div>\r\n        </div>\r\n        <div class=\"zm-main-content mt16\" style=\"min-height: 60vh;\">\r\n            <a-table\r\n                v-if=\"list.length > 0\"\r\n                :loading=\"loading\"\r\n                :data-source=\"list\"\r\n                :columns=\"columns\"\r\n                :pagination=\"pagination\"\r\n                @resizeColumn=\"handleResizeColumn\"\r\n                @change=\"tableChange\"\r\n            >\r\n                <template #bodyCell=\"{column, text, record}\">\r\n                    <template v-if=\"column.dataIndex === 'msg_content'\">\r\n                        <div class=\"msg-content-box\" v-html=\"record.msg_content\"></div>\r\n                    </template>\r\n                    <template v-else-if=\"column.dataIndex === 'sender_info'\">\r\n                        <div class=\"zm-user-info\">\r\n                            <img class=\"avatar\" :src=\"record?.sender_info?.avatar || defaultAvatar\"/>\r\n                            <span class=\"name\">{{ record?.sender_info?.name }}</span>\r\n                        </div>\r\n                    </template>\r\n                    <template v-else-if=\"column.dataIndex === 'receiver_info'\">\r\n                        <div v-if=\"record?.receiver_info\" class=\"zm-user-info\">\r\n                            <img class=\"avatar\" :src=\"record?.receiver_info?.avatar || defaultAvatar\"/>\r\n                            <span class=\"name\">{{ record?.receiver_info?.name }}</span>\r\n                        </div>\r\n                    </template>\r\n                    <template v-else-if=\"column.dataIndex === 'group_info'\">\r\n                        <div v-if=\"record.group_info\">\r\n                            {{ record.group_info?.group_name || '未命名群聊' }}\r\n                        </div>\r\n                    </template>\r\n                    <template v-else-if=\"column.dataIndex === 'id'\">\r\n                        <a @click=\"openDetail(record)\">查看明细</a>\r\n                    </template>\r\n                </template>\r\n            </a-table>\r\n            <a-empty v-else\r\n                     style=\"margin-top: 88px;\"\r\n                     :description=\"filterData.keyword ? '暂无匹配数据' : '输入内容后搜索查看'\">\r\n                <template #image>\r\n                    <img src=\"@/assets/image/data-empty.png\"/>\r\n                </template>\r\n            </a-empty>\r\n        </div>\r\n    </MainLayout>\r\n</template>\r\n\r\n<script setup>\r\nimport {h, reactive, ref} from 'vue';\r\nimport {useRoute, useRouter} from 'vue-router';\r\nimport dayjs from 'dayjs';\r\nimport {SearchOutlined} from '@ant-design/icons-vue';\r\nimport {message} from 'ant-design-vue';\r\nimport MainLayout from \"@/components/mainLayout.vue\";\r\nimport {searchSession} from \"@/api/session\";\r\nimport {getRegex} from \"@/utils/tools\";\r\n\r\nconst router = useRouter()\r\nconst route = useRoute()\r\nconst defaultAvatar = require('@/assets/default-avatar.png');\r\nconst columns = [\r\n    {\r\n        title: \"会话内容\",\r\n        dataIndex: \"msg_content\",\r\n        width: 260,\r\n    },\r\n    {\r\n        title: \"会话类型\",\r\n        dataIndex: \"session_type_text\",\r\n        width: 160,\r\n    },\r\n    {\r\n        title: \"群聊名称\",\r\n        dataIndex: \"group_info\",\r\n        width: 160,\r\n    },\r\n    {\r\n        title: \"发送人\",\r\n        dataIndex: \"sender_info\",\r\n        width: 160,\r\n    },\r\n    {\r\n        title: \"接收人\",\r\n        dataIndex: \"receiver_info\",\r\n        width: 160,\r\n    },\r\n    {\r\n        title: \"发送时间\",\r\n        dataIndex: \"msg_time\",\r\n        width: 160,\r\n    },\r\n    {\r\n        title: \"操作\",\r\n        dataIndex: \"id\",\r\n        width: 120,\r\n    }\r\n]\r\nconst handleResizeColumn = (w, col) => {\r\n    col.width = w;\r\n}\r\nconst loading = ref(false)\r\nconst list = ref([])\r\nconst pagination = reactive({\r\n    pageSize: 50,\r\n    current: 1,\r\n    total: 0\r\n})\r\nconst filterData = reactive({\r\n    keyword: '',\r\n    session_type: undefined,\r\n    from_type: 0,\r\n    dates: [],\r\n    from: '',\r\n})\r\n\r\nconst search = () => {\r\n    list.value = []\r\n    pagination.current = 1\r\n    pagination.total = 0\r\n    loadData()\r\n}\r\n\r\nconst loadData = () => {\r\n    loading.value = true\r\n    let params = {\r\n        page: pagination.current,\r\n        size: pagination.pageSize\r\n    }\r\n    filterData.keyword = filterData.keyword.trim()\r\n    filterData.from = filterData.from.trim()\r\n    if (!filterData.keyword) {\r\n        message.warn('请输入搜索内容')\r\n        return\r\n    }\r\n    params.keyword = filterData.keyword\r\n    if (filterData.session_type) {\r\n        params.session_type = filterData.session_type\r\n    }\r\n    if (filterData.from) {\r\n        params.from = filterData.from\r\n        if (filterData.from_type > 0) {\r\n            params.from_type = filterData.from_type\r\n        }\r\n    }\r\n    if (filterData.dates.length) {\r\n        params.start_time = filterData.dates[0].format('YYYY-MM-DD 00:00:01')\r\n        params.stop_time = filterData.dates[1].format('YYYY-MM-DD 23:59:59')\r\n    }\r\n    searchSession(params).then(res => {\r\n        let data = res.data || {}\r\n        let {items, total} = data\r\n        items.map(item => {\r\n            item.msg_content = item.msg_content.replace(getRegex(filterData.keyword), `<span class=\"search-keyword-text\">${filterData.keyword}</span>`)\r\n            item.session_type_text = item.group_info ? '群聊' : '单聊'\r\n            item.msg_time = dayjs(item.msg_time).format('YY/MM/DD HH:mm')\r\n        })\r\n        list.value = items\r\n        pagination.total = Number(total)\r\n    }).finally(() => {\r\n        loading.value = false\r\n    })\r\n}\r\n\r\nconst tableChange = p => {\r\n    pagination.current = p.current\r\n    pagination.pageSize = p.pageSize\r\n    search()\r\n}\r\n\r\nconst filterDateChange = () => {\r\n    if (filterData.dates.length > 0) {\r\n        let time = filterData.dates[1] - filterData.dates[0]\r\n        if ((time / 86400000) > 30) {\r\n            filterData.dates = []\r\n            message.warning(\"发送时间跨度不得超过30天\")\r\n        }\r\n    }\r\n    search()\r\n}\r\n\r\nconst openDetail = record => {\r\n    let params = {}\r\n    if (record.group_info) {\r\n        params.group_chat_id = record.roomid\r\n    } else {\r\n        params.conversation_id = record.conversation_id\r\n        params.sender = record.from\r\n        params.receiver = record?.to_list[0] || ''\r\n        params.sender_type = record.from_role\r\n        params.receiver_type = record.to_role\r\n    }\r\n    let href = router.resolve({\r\n        path: '/sessionArchive/index',\r\n        query: params\r\n    }).href\r\n    window.open(href)\r\n}\r\n\r\nconst disabledDate = current => {\r\n    return current && current > dayjs().endOf('day')\r\n}\r\n</script>\r\n\r\n<style scoped lang=\"less\">\r\n.zm-filter-box {\r\n    flex-wrap: wrap;\r\n\r\n    .zm-filter-item {\r\n        margin-top: 12px;\r\n        margin-right: 12px;\r\n    }\r\n}\r\n\r\n.zm-main-content {\r\n    :deep(.ant-empty-image) {\r\n        height: 200px;\r\n        margin-bottom: 0;\r\n    }\r\n\r\n    :deep(.msg-content-box) {\r\n        word-break: break-all;\r\n        .search-keyword-text {\r\n            color: red;\r\n        }\r\n    }\r\n}\r\n</style>\r\n","import script from \"./search.vue?vue&type=script&setup=true&lang=js\"\nexport * from \"./search.vue?vue&type=script&setup=true&lang=js\"\n\nimport \"./search.vue?vue&type=style&index=0&id=4eab6876&scoped=true&lang=less\"\n\nimport exportComponent from \"../../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['__scopeId',\"data-v-4eab6876\"]])\n\nexport default __exports__"],"names":["staffCstSessions","data","request","get","params","staffSessions","groupSessions","cstSessions","sessionMessage","groupMessage","searchSession","router","useRouter","defaultAvatar","useRoute","require","columns","title","dataIndex","width","handleResizeColumn","w","col","loading","ref","list","pagination","reactive","pageSize","current","total","filterData","keyword","session_type","undefined","from_type","dates","from","search","value","loadData","page","size","trim","length","start_time","format","stop_time","then","res","items","map","item","msg_content","replace","getRegex","session_type_text","group_info","msg_time","dayjs","Number","finally","message","warn","tableChange","p","filterDateChange","time","warning","openDetail","record","group_chat_id","roomid","conversation_id","sender","receiver","to_list","sender_type","from_role","receiver_type","to_role","href","resolve","path","query","window","open","disabledDate","endOf","__exports__"],"sourceRoot":""}